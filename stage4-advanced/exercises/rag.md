# RAG（検索拡張生成）実装演習

## 目的

この演習では、RAG（検索拡張生成）システムを構築し、法務文書に対する高精度な質問応答システムを実装する方法を学びます。ベクトルデータベースの基礎、埋め込みモデルの活用、検索拡張生成の仕組みを理解し、実際に法務文書のRAGシステムを構築することを目的としています。

## 準備

1. 必要なライブラリをインストールしてください
   ```bash
   pip install openai chromadb pypdf2 pandas numpy python-dotenv tqdm
   ```

2. OpenAI APIキーを取得し、環境変数として設定してください
   ```bash
   # .envファイルを作成
   echo "OPENAI_API_KEY=your_api_key_here" > .env
   ```

3. サンプルの法務文書を用意してください
   - 用意できない場合は、`code-examples/rag_implementation.py`のサンプル契約書テキストを使用してください

## 演習1：データの前処理とチャンク分割

### 課題1-1：PDFからのテキスト抽出

1. 以下の関数を実装して、PDFファイルからテキストを抽出してください
   ```python
   def extract_text_from_pdf(pdf_path):
       # PDFからテキストを抽出するコードを実装
       pass
   ```

2. 抽出したテキストをクリーニングする関数を実装してください
   ```python
   def clean_text(text):
       # テキストのクリーニングを行うコードを実装
       pass
   ```

### 課題1-2：テキストのチャンク分割

1. 以下の関数を実装して、テキストを適切なサイズのチャンクに分割してください
   ```python
   def split_text_into_chunks(text, chunk_size=1000, overlap=200):
       # テキストをチャンクに分割するコードを実装
       pass
   ```

2. 分割したチャンクを確認し、適切なサイズと重複になっているか評価してください

## 演習2：埋め込みベクトルの生成とベクトルデータベースの構築

### 課題2-1：埋め込みベクトルの生成

1. 以下の関数を実装して、テキストチャンクの埋め込みベクトルを生成してください
   ```python
   def generate_embeddings(chunks, model="text-embedding-3-small"):
       # 埋め込みベクトルを生成するコードを実装
       pass
   ```

2. 生成した埋め込みベクトルの次元数と特性を確認してください

### 課題2-2：ChromaDBを使用したベクトルデータベースの構築

1. 以下の関数を実装して、ChromaDBにベクトルデータベースを構築してください
   ```python
   def create_vector_db(collection_name, chunks, metadata=None):
       # ベクトルデータベースを構築するコードを実装
       pass
   ```

2. メタデータを適切に設定し、検索時に活用できるようにしてください

## 演習3：検索機能の実装

### 課題3-1：ベクトル検索の実装

1. 以下の関数を実装して、ユーザークエリに基づいて関連ドキュメントを検索してください
   ```python
   def search_documents(collection, query, top_k=3):
       # ベクトル検索を実行するコードを実装
       pass
   ```

2. 検索結果の類似度スコアを確認し、検索精度を評価してください

### 課題3-2：検索結果のフィルタリングと再ランキング

1. 以下の関数を実装して、メタデータに基づいて検索結果をフィルタリングしてください
   ```python
   def filter_search_results(collection, query, filter_criteria, top_k=5):
       # フィルタリング付きの検索を実装
       pass
   ```

2. 検索結果を再ランキングする機能を実装してください
   ```python
   def rerank_search_results(results, query):
       # 検索結果の再ランキングを実装
       pass
   ```

## 演習4：LLMとの統合

### 課題4-1：プロンプトエンジニアリング

1. 以下のプロンプトテンプレートを作成し、検索結果をLLMへの入力に統合してください
   ```python
   def create_prompt(query, contexts):
       # プロンプトテンプレートを作成
       pass
   ```

2. 異なるプロンプトテンプレートを試し、回答の質を比較してください

### 課題4-2：回答生成機能の実装

1. 以下の関数を実装して、検索結果を基にLLMで回答を生成してください
   ```python
   def generate_answer(query, contexts, model="gpt-4"):
       # LLMで回答を生成するコードを実装
       pass
   ```

2. 生成された回答の品質を評価し、必要に応じてパラメータを調整してください

## 演習5：法務質問応答システムの構築

### 課題5-1：統合システムの実装

1. 以下の関数を実装して、法務質問に回答する統合システムを構築してください
   ```python
   def answer_legal_question(collection, query, top_k=3):
       # 法務質問応答システムを実装
       pass
   ```

2. 複数の質問に対する回答を生成し、システムの性能を評価してください

### 課題5-2：出典情報の提示

1. 回答と共に出典情報（元の文書名、該当箇所など）を提示する機能を実装してください
   ```python
   def answer_with_sources(collection, query, top_k=3):
       # 出典情報付きの回答を生成
       pass
   ```

2. 出典情報の正確性を確認し、必要に応じて改善してください

## 演習6：RAGシステムの評価と最適化

### 課題6-1：評価指標の設定と測定

1. 以下の評価指標を測定するコードを実装してください
   - 正確性（Accuracy）
   - 関連性（Relevance）
   - 回答時間（Latency）
   - 幻覚の割合（Hallucination Rate）

2. テストケースを作成し、システムの性能を評価してください

### 課題6-2：システムの最適化

1. 以下のパラメータを調整して、システムの性能を最適化してください
   - チャンクサイズ
   - 重複（オーバーラップ）の量
   - 検索結果数（top-k）
   - 埋め込みモデル
   - LLMのパラメータ（temperature, max_tokensなど）

2. 最適化前後の性能を比較し、改善点を分析してください

## 提出課題

以上の演習を通じて学んだことを活かして、以下の課題に取り組んでください：

1. 法務文書（契約書、法令、判例など）を対象としたRAGシステムを構築してください
   - 少なくとも10件以上の法務文書を含めること
   - 適切なチャンク分割と埋め込み生成を行うこと
   - 高精度な検索と回答生成を実現すること

2. 以下の機能を実装してください
   - 文書のアップロードと自動インデックス化
   - 質問応答インターフェース
   - 出典情報の表示
   - 回答の信頼度スコアの表示

3. 以下の内容を含むレポートを作成してください（800〜1,200字程度）：
   - システムの設計と実装方法
   - 使用したデータと前処理方法
   - 評価結果と最適化プロセス
   - 法務分野におけるRAGの有用性と限界
   - 今後の改善点

4. システムのデモンストレーション動画（3分程度）を作成してください

提出方法：研修用ポータルサイトの課題提出ページからソースコード、レポート、デモ動画をアップロードしてください。 